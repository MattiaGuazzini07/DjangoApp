{% load static %}
<!DOCTYPE html>
<html>
<head>
  <title>Task di {{ user.username }}</title>
  <link rel="stylesheet" href="{% static 'todo/admin.css' %}?v=2">
  <link rel="icon" href="{% static 'favicon.png' %}" type="image/png">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

  <h2>Task di {{ user.username }}</h2>

  <!-- ✅ Form creazione task -->
  <div class="form-wrapper" style="margin-bottom: 50px;">
    <div class="form-container">
      <h3 style="margin-top: 0;">Crea nuovo task</h3>
      <form method="POST" action="{% url 'user_tasks' user.id %}" class="user-form">
        {% csrf_token %}
        <div>
          <label for="{{ form.title.id_for_label }}">Titolo:</label>
          {{ form.title }}
        </div>
        <div>
          <label for="{{ form.due_date.id_for_label }}">Data di scadenza:</label>
          {{ form.due_date }}
        </div>
        <div>
          <label for="{{ form.priority.id_for_label }}">Priorità:</label>
          {{ form.priority }}
        </div>
        <div>
          <label for="{{ form.is_completed.id_for_label }}">Completato:</label>
          {{ form.is_completed }}
        </div>
        <button type="submit" class="submit-btn">Crea task</button>
      </form>
    </div>
  </div>

  <!-- ✅ Tabella task -->
  <table>
    <thead>
      <tr>
        <th>Titolo</th>
        <th>Completato</th>
        <th>Data creazione</th>
        <th>Priorità</th>
        <th>Azioni</th>
      </tr>
    </thead>
    <tbody>
      {% for task in tasks %}
      <tr>
        <td>{{ task.title }}</td>
        <td>{% if task.is_completed %}✅{% else %}❌{% endif %}</td>
        <td>{{ task.created_at|date:"Y-m-d H:i" }}</td>
        <td>{{ task.get_priority_display }}</td>
        <td>
          <a href="{% url 'edit_task' task.id %}" class="btn-admin">Modifica</a>
        </td>
      </tr>
      {% empty %}
      <tr><td colspan="5">Nessun task presente</td></tr>
      {% endfor %}
    </tbody>
  </table>

  <a href="{% url 'admin_dashboard' %}">← Torna alla dashboard</a>

  <!-- ✅ Grafico -->
  <div class="chart-container">
    <h3 style="text-align: center;">Stato dei task</h3>
    <canvas id="taskChart"></canvas>
  </div>

  <script>
    const total = {{ total_count }};
    const completed = {{ completed_count }};
    const pending = total - completed;

    const ctx = document.getElementById('taskChart').getContext('2d');
    new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: ['Completati', 'Da fare'],
        datasets: [{
          data: [completed, pending],
          backgroundColor: ['#28a745', '#ffc107'],
          borderColor: ['#fff', '#fff'],
          borderWidth: 2
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false
      }
    });
  </script>
</body>
</html>
